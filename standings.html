<!DOCTYPE html>
<html>
<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-125711097-1"></script>
	<script src="javascript/ga.js"></script>
	<title>Standings</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="css/navBar.css">
	<script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
	<script src="javascript/navBar.js"></script>
	<h1>Standings</h1>
	<select id="typeSelect" class="pullData">
		<option disabled>Model Type</option>
		<option value='all' selected>Points Scored and Draft Value</option>
		<option value='draft'>Draft Value</option>
		<option value='points'>Points Scored Only</option>
		<option value='coin'>Coin Flip</option>
	</select>
	<table id="standTable" class='table table-hover table-striped'>
		<thead>
		</thead>
		<tbody>
		</tbody>
	</table>
	<select id="graphSelect">
		<option disabled>Graphed Value</option>
		<option value = 'pointAverage'>Points Average</option>
		<option value = 'exPointAverage'>Expected Points Average</option>
		<option value = 'exWins'>Expected Wins</option>
		<option value = 'playoffsOdds'>Playoffs Odds</option>
		<option value = 'champOdds'>Champ Odds</option>
		<option value = 'highpoints'>High Points Odds</option>
		<option value = 'lowPoints'>Low Points Odds</option>
	</select>
	<div id="graph-div">
		
	</div>
	<script>
		//League winner data
		var divSize = {'height' : 700, 'width' : 1000}
		var margins ={'top' : 20,
					  'bottom' : 50,
					  'left' : 40,
					  'right' : 20}
		d3.selectAll("select.pullData")
			.on("change",returnValues);
		returnValues();
		svg = d3.select("#graph-div")
			.append("svg")
			.attr('height', divSize.height + margins.top + margins.bottom)
			.attr("width", divSize.width + margins.left + margins.right)
			.style("border","1px solid black")
			.style("margin","10px")
			.append("g")
				.attr("transform","translate("+margins.left+","+margins.top+")");
				
		d3.select("#graph-div")
			.append("svg")
			.attr("id","legend")
			.attr('height', divSize.height + margins.top + margins.bottom)
			.attr("width", 200)
			.style("border","1px solid black")
			.style("margin","10px");
		function returnValues() {
			var selectType = d3.select("#typeSelect").property("value");
			var d3Champs = d3.json("php/standings.php?type="+selectType).then(function(data) {
				d3.select("#standTable").select("thead").selectAll("*").remove();
				d3.select("#standTable").select("tbody").selectAll("*").remove();
				var ths = d3.select("#standTable").select("thead")
					.append("tr")
					.selectAll("th")
					.data(d3.keys(data[0]))
					.enter()
					.append("th")
						.text(function(d) {return d;})
						.on("click",function(d) {
							d3.select("#standTable").select("tbody").selectAll("tr").remove();
							columnName = d3.select(this).text();
							switch(columnName) {
								case 'Team':
									data = data.sort(function(a, b) {return d3.ascending(a[columnName],b[columnName])});
									break;
								case 'Wins':
								case 'Losses':
								case 'Tie':
								case 'Points Scored':
								case 'Average Points':
									data = data.sort(function(a, b) {return d3.descending(+a[columnName],+b[columnName])});
									break;
								case 'Expected End of Year Point Average':
								case 'Expected End of Year Wins':
								case 'Playoffs Odds':
								case 'Lowest Points Odds':
								case 'Highest Points Odds':
								case 'Champ Odds':
									data = data.sort(function(a, b) {return d3.descending(
										+a[columnName].split(' ')[0],
										+b[columnName].split(' ')[0]
										)});								
									break;
									
							}
							
							var trs = d3.select("#standTable").select("tbody")
								.selectAll("tr")
								.data(data)
								.enter()
								.append("tr");
							
							trs.selectAll("td")
								.data(function(d) {return d3.values(d);})
								.enter()
								.append("td")
								.text(function(d) {return d;});
							
							
						});
				var trs = d3.select("#standTable").select("tbody")
							.selectAll("tr")
							.data(data)
							.enter()
							.append("tr");
							
				trs.selectAll("td")
					.data(function(d) {return d3.values(d);})
					.enter()
					.append("td")
					.text(function(d) {return d;});
			});
			
			var d3Graph = d3.json("php/standingsGraph.php?type="+selectType).then(function(data) {
			
				d3.select("#graphSelect").on("change",doGraph);
				
				doGraph();
				
				function doGraph() {
					var selectGraph = d3.select("#graphSelect").property("value");
					var svgGraph = d3.select("svg").select("g")
					
					var data2 = data.filter(function(d) {return +d.standWeek > 0 || selectGraph != 'pointAverage';});
					var color = d3.scaleOrdinal(['#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080', '#ffffff', '#000000']);
					svgGraph.selectAll("*").remove();
					
					var xScale = d3.scalePoint()
						.range([0, divSize.width])
						.domain(data2.map(function(d) {return d.standWeek;}))
						.padding(.1);
						
					var yScale = d3.scaleLinear()
						.range([divSize.height,0])
						.domain([0,d3.max(data2, function(d) {
							if(selectGraph == 'pointAverage')
								{return +d.pointsScored/(+d.wins+(+d.losses)+(+d.tie));}
							else if (selectGraph == 'exPointAverage')
								{return +d.exPointAverage/13;}
							else {return +d[selectGraph];}
							})]);
						
						
					var xAxis = d3.axisBottom()
						.scale(xScale);
						
					var yAxis = d3.axisLeft()
						.scale(yScale);
						
					svgGraph.append("g")
						.call(xAxis)
						.attr("transform","translate(0,"+divSize.height+")");
						
					svgGraph.append("g")
						.call(yAxis);
						
						
					var valueline = d3.line()
						.curve(d3.curveLinear)
						.x(function(d) {
						 return xScale(d.standWeek); })
						.y(function(d) { if(selectGraph == 'pointAverage') {
						return yScale(+d.pointsScored/(+d.wins+(+d.losses)+(+d.tie)));}
							else if (selectGraph == 'exPointAverage')
								{return yScale(+d.exPointAverage/13);}
						else {
						return yScale(+d[selectGraph]);
						} });
						
						
					var playerData = d3.nest()
						.key(function(d) {return d.Team;})
						.entries(data2);
						
					var dataPath = playerData.forEach(function(d, i) {
						svgGraph
							.append("path")
							.attr("class", d.key + " graph_line")
						.attr("id", d.key)
						.style("stroke",color(d.key))
						.style("stroke-width","2px")
						.style("fill","none")
						.attr("d", valueline(d.values.sort(function(a,b) {
							return d3.ascending(a.standWeek, b.standWeek);
							})))
						.append("title")
							.html(d.key);
							
						d3.select("#legend")
							.append("text")
							.attr("x",100)
							.attr("y",  (1 + i) * (divSize.height/playerData.length))
							.text(d.key)
							.style("fill",color(d.key))
							.style("text-anchor","middle")
							.on("mouseover",function(d) {
								var selected = d3.select(this).text();
								d3.selectAll(".graph_line")
									.attr("opacity",.5)
									.style("stroke-width","1px");
								d3.selectAll(".graph_line."+selected.split(" ").join("."))
									.attr("opacity",1)
									.style("stroke-width","4px");
							})
							.on("mouseout", function(d) {
								d3.selectAll(".graph_line")
									.attr("opacity",1)
									.style("stroke-width","2px");
							
							});
						
					})

				
				}
			});
		}
	</script
</body>
</html>