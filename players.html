<!DOCTYPE html>
<html>
<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-125711097-1"></script>
	<script src="javascript/ga.js"></script>
	<title>Players</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="css/navBar.css">
	<script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
	<script src="javascript/navBar.js"></script>
	<div id='bodydiv'>
		<div id='bodyHeadDiv'>
			<h1 id = 'playerTitle'></h1>
		</div>
	</div>
	<script>
		var color = d3.scaleOrdinal(['#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', 
			'#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9a6324', 	
			'#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080', '#ffffff', '#000000']);
			
		var urlParams = new URLSearchParams(window.location.search);
		var player = urlParams.get('player').split('-').join(' ');
		document.title = player.split('_').join("'");
		d3.select("#playerTitle").text(player.split('_').join("'"));
		
		var request = new XMLHttpRequest();

		// Open a new connection, using the GET request on the URL endpoint
		var playerQuery = player.split(' ').join('+').split('_').join("'");
		request.open('GET', 'https://www.googleapis.com/customsearch/v1?key=AIzaSyBKV7vpVLBhpggv_X041NSsxi2_JoJmsgo&cx=010003257524888520746:js_pte8i3r4&q='+playerQuery+'+nfl', true);
		
		request.onload = function () {
		  var data = JSON.parse(this.response);
			d3.select("#bodyHeadDiv").append("img")
				.attr("src",data.items[0].pagemap.cse_image[0].src)
				.style("height","200px")
				.style("float","right");
		  
		  }
		
		request.send();
		var dataPull = d3.json("php/player.php?player="+urlParams.get('player')+"&pos="+urlParams.get('position')).then(function(data) {
			console.log(data);
			var table = d3.select("#bodydiv")
				.append("table")
				.attr("class","table-bordered")
				.style("margin-left","5px");
				
			var thead = table.append("thead").append("tr");
			
			var tbody = table.append("tbody").append("tr");
			
			var ths = ['Points', 'Position', 'NFL Teams', 'La Liga Teams', 'First Year', 'Last Year', 'Winning %','Championships Won'];
			
			thead.selectAll("th")
				.data(ths)
				.enter()
				.append("th")
				.text(function(d) {return d;});
				
			var tds = [];
			
			tds.push(d3.sum(data,function(d) {return Math.round(d.team=="FA"?+d.faPoints:+d.scoredPoints);}));
			
			tds.push(d3.map(data,function(d) {return d.playerPosition.toUpperCase().trim();}).keys().join(', '));
			
			tds.push(d3.map(data,function(d) {return d.playerTeam.toUpperCase().trim();}).keys().join(', '));
			
			tds.push(d3.map(data.filter(function(d) {return d.team != 'FA';}),function(d) {
				return "<span style='color:" + d3.rgb(color(d.team.trim())) + "'>" + d.team.trim() + "</span>";
			}).keys().join(', '));
			
			tds.push(d3.min(data, function(d) {return +d.season;}));
			
			tds.push(d3.max(data, function(d) {return +d.season;}));
			
			tds.push(Math.round((d3.sum(data, function(d) {return +d.winWin;})/data.filter(function(d) {return d.winWin != null;}).length)*100)/100);
			
			tds.push(d3.map(data.filter(function(d) {return d.winWin == 1 && d.playoffs == "championship";}),function(d) {return d.season;}).keys().join(', '));
			
			tbody.selectAll("td")
				.data(tds)
				.enter()
				.append("td")
				.html(function(d) {return d;});
				
			var height = 300, width = 900;
			
			var margins = {'top' : 5, 'bottom' : 40, 'left' : 20, 'right' : 15}
				
			var svg = d3.select("#bodydiv")
				.append("svg")
				.attr("height", height + margins.top + margins.bottom)
				.attr("width", width + margins.left + margins.right)
				.style("border","1px solid black")
				.append("g")
				.attr("transform","translate("+margins.left+","+margins.top+")");
				
			var yScale = d3.scaleLinear()
				.range([height,0])
				.domain([d3.min([0,d3.min(data,function(d) {return d.team == 'FA'?+d.faPoints:+d.scoredPoints;})]),
					d3.max(data,function(d) {return d.team == 'FA'?+d.faPoints:+d.scoredPoints;})]);
			console.log([d3.min([0,d3.min(data,function(d) {return d.team == 'FA'?+d.faPoints:+d.scoredPoints;})]),
					d3.max(data,function(d) {return d.team == 'FA'?+d.faPoints:+d.scoredPoints;})]);
			var yAxis = d3.axisLeft()
				.scale(yScale);
				
			var xScale = d3.scaleBand()
				.range([0,width])
				.domain(d3.map(data,function(d) {return d.season;}).keys())
				.padding(.05);
			console.log(xScale.bandwidth());
			var xAxis = d3.axisBottom()
				.scale(xScale);
				
			svg.append("g")
				.call(yAxis)
				.attr("class","y axis");
				
			svg.append("g")
				.call(xAxis)
				.attr("class","x axis")
				.attr("transform","translate(0,"+height+")")
				
			var weekTable = d3.select("#bodydiv")
				.append("table")
				.attr("class","table-bordered")
				.attr("id","weekTable");
				
			var weekHead = weekTable.append("thead").append("tr");
			var weekBody = weekTable.append("tbody");
			
			var weekHeads = ['Year','Week','NFL Team','La Liga Team','Bench','Points','Win','Playoffs','Draft'];
			
			weekHead.selectAll('th')
				.data(weekHeads)
				.enter()
				.append("th")
				.text(function(d) {return d;});
				
			var years = d3.map(data, function(d) {return d.season;}).keys().sort(function(a, b) {return b - a;});
			
			years.forEach(function(d) {
				for(var i = 16; i >= 1; i += -1) {
					weekTr = weekTable.append("tr");
					weekTr.append("td").attr('align','right').text(d);
					weekTr.append("td").attr('align','right').text(i);
					
					weekData = data.filter(function(v) {return v.season == d && v.week == i;})[0]
					
					weekTr.append("td").text(weekData?weekData.playerTeam:'');
					weekTr.append("td").text(weekData?weekData.team:'FA');
					weekTr.append("td").text(weekData?((weekData.team != 'FA' && weekData.bench == 'Bench')?'Y':''):'');
					weekTr.append("td").attr('align','right').text(weekData?((weekData.team != 'FA')?Math.round(weekData.scoredPoints):Math.round(weekData.faPoints)):'');
					weekTr.append("td").text(weekData?(
						(weekData.team != 'FA' && weekData.winWin == 1)?'W':(
							(weekData.team != 'FA' && weekData.winWin == 0)?'L':''
						)
					):'');
					weekTr.append("td").text(weekData?weekData.playoffs:'');
					weekTr.append("td").text(weekData?weekData.draftPlace:'');
					var pointsScored = weekData?((weekData.team != 'FA')?Math.round(weekData.scoredPoints):Math.round(weekData.faPoints)):'';
					var team = weekData?weekData.team:'';
					var win = weekData?(
						(weekData.team != 'FA' && weekData.winWin == 1)?'green':(
							(weekData.team != 'FA' && weekData.winWin == 0)?'red':'none'
						)
					):'none';
					
					svg.append('rect')
						.attr("x",xScale(d)+ (i/16) * xScale.bandwidth() - (((1/16) * xScale.bandwidth())*.225))
						.attr("y",0)
						.attr("width",(xScale.bandwidth()/16)*.9)
						.attr("height",height)
						.style("fill",win)
						.style("opacity",.1);
					svg.append('rect')
						.attr("x",xScale(d)+ (i/16) * xScale.bandwidth())
						.attr("y",yScale(d3.max([0,pointsScored])))
						.attr("width",(xScale.bandwidth()/16)*.4)
						.attr("height",yScale(0)-yScale(Math.abs(+pointsScored)))
						.style("fill",team=="FA"?'grey':d3.rgb(color(team)).darker(weekData? weekData.bench== 'Bench'?1:0:0));
					
				}
			});
				
				
			
			
			
			
		
		});
	</script
</body>
</html>